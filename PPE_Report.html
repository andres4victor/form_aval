<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPE Report Dashboard - Enterprise v6.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #c41e3a 0%, #7d1d2e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #c41e3a 0%, #7d1d2e 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-bottom: 5px solid rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: clamp(1.5em, 5vw, 2.5em);
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            font-size: clamp(0.9em, 3vw, 1.1em);
            opacity: 0.95;
        }

        .content {
            padding: clamp(15px, 5vw, 30px);
            flex: 1;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .tab-btn.active {
            color: #c41e3a;
            border-bottom-color: #c41e3a;
        }

        .tab-btn:hover {
            color: #c41e3a;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #fce5e8 0%, #f8d1d7 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #c41e3a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .kpi-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2em;
            color: #c41e3a;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            height: 400px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #c41e3a;
            box-shadow: 0 0 10px rgba(196, 30, 58, 0.2);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #c41e3a 0%, #7d1d2e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(196, 30, 58, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #333;
        }

        .btn-secondary:hover {
            background: #bdc3c7;
        }

        .table-wrapper {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        th {
            background: linear-gradient(135deg, #c41e3a 0%, #7d1d2e 100%);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            border: 1px solid rgba(0,0,0,0.1);
        }

        th:hover {
            background: linear-gradient(135deg, #7d1d2e 0%, #c41e3a 100%);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
        }

        tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        tbody tr:hover {
            background: #f0f4ff;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-top-color: #c41e3a;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            background: #f9fafb;
            border-top: 1px solid #ecf0f1;
            padding: 15px 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.85em;
        }

        .monthly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .monthly-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border-top: 4px solid #c41e3a;
        }

        .monthly-card h4 {
            color: #c41e3a;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 600;
            color: #333;
        }

        .metric-value {
            color: #c41e3a;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
            vertical-align: middle;
        }

        .status-excellent {
            background: #27ae60;
        }

        .status-good {
            background: #f39c12;
        }

        .status-warning {
            background: #e74c3c;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .report-section h3 {
            color: #c41e3a;
            margin-bottom: 15px;
            border-bottom: 2px solid #c41e3a;
            padding-bottom: 10px;
        }

        .report-list li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .ai-analysis {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8ecf8 100%);
            border-left: 5px solid #c41e3a;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            font-size: 0.95em;
            line-height: 1.7;
            color: #333;
        }

        .faq-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .faq-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #c41e3a;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .faq-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(196, 30, 58, 0.15);
        }

        .faq-card h4 {
            color: #c41e3a;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-badge {
            display: inline-block;
            background: #c41e3a;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75em;
            font-weight: bold;
        }

        .faq-answer {
            color: #555;
            font-size: 0.9em;
            line-height: 1.6;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }

        .faq-card.open .faq-answer {
            max-height: 500px;
        }

        .metric-detail {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border-left: 3px solid #c41e3a;
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä PPE Report Dashboard Enterprise</h1>
            <p>An√°lise Consolidada e Relat√≥rio Gerencial - v6.0</p>
        </div>

        <div class="content">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('dashboard')">üìà Dashboard</button>
                <button class="tab-btn" onclick="switchTab('mensais')">üìÖ An√°lise Mensal</button>
                <button class="tab-btn" onclick="switchTab('relatorio')">üìã Relat√≥rio Gerencial</button>
                <button class="tab-btn" onclick="switchTab('faq')">‚ùì FAQ</button>
                <button class="tab-btn" onclick="switchTab('dados')">üìä Dados</button>
            </div>

            <div id="dashboard" class="tab-content active">
                <div style="margin-bottom: 20px; display: flex; gap: 10px; align-items: center;">
                    <label style="font-weight: 600; color: #333;">Per√≠odo:</label>
                    <select id="periodSelect" onchange="updateDashboard()" style="padding: 10px 15px; border: 2px solid #c41e3a; border-radius: 8px; font-size: 0.95em; cursor: pointer;">
                        <option value="all">Todos os Dados</option>
                        <option value="last30">√öltimos 30 dias</option>
                        <option value="last60">√öltimos 60 dias</option>
                        <option value="last90">√öltimos 90 dias</option>
                    </select>
                </div>

                <h3 style="color: #c41e3a; margin-top: 20px; margin-bottom: 15px;">üìä M√©tricas Principais</h3>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Taxa de Abertura M√©dia</div>
                        <div class="kpi-value" id="kpiOpenRate">0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Taxa de Entrega M√©dia</div>
                        <div class="kpi-value" id="kpiDeliveryRate">0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Taxa de Clique (CTR)</div>
                        <div class="kpi-value" id="kpiCTR">0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Taxa de Cancelamento</div>
                        <div class="kpi-value" id="kpiUnsubscribe">0%</div>
                    </div>
                </div>

                <h3 style="color: #c41e3a; margin-top: 20px; margin-bottom: 15px;">üìà Consolidado</h3>
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-label">Total de Campanhas</div>
                        <div class="kpi-value" id="kpiTotal">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">PPE Score M√©dio</div>
                        <div class="kpi-value" id="kpiAvgScore">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">√öltima Atualiza√ß√£o</div>
                        <div class="kpi-value" id="kpiData" style="font-size: 1.2em;">--</div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chartDeliveryTrend"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="chartMetricasComparacao"></canvas>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartTopCampaigns"></canvas>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="chartWorstCampaigns"></canvas>
                    </div>
                </div>
            </div>

            <div id="relatorio" class="tab-content">
                <div class="report-section">
                    <h3>üìå Resumo Executivo</h3>
                    <div id="resumoExecutivo"></div>
                </div>

                <div class="report-section">
                    <h3>üéØ KPIs e M√©tricas Principais</h3>
                    <ul class="report-list" id="kpisRelatorio"></ul>
                </div>

                <div class="report-section">
                    <h3>üìä An√°lise de Tend√™ncias (IA)</h3>
                    <div id="analiseTendencias" class="ai-analysis" style="color: #999; font-style: italic;">
                        ‚è≥ Gerando an√°lise com intelig√™ncia artificial...
                    </div>
                </div>

                <div class="report-section">
                    <h3>‚ö†Ô∏è Alertas e Recomenda√ß√µes</h3>
                    <ul class="report-list" id="alertas"></ul>
                </div>
            </div>

            <div id="mensais" class="tab-content">
                <div class="monthly-grid" id="monthlyContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Carregando dados mensais...</p>
                    </div>
                </div>
            </div>

            <div id="faq" class="tab-content">
                <h2 style="color: #c41e3a; margin-bottom: 20px;">üìö Entenda Cada M√©trica</h2>
                <div class="faq-grid" id="faqContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>

            <div id="dados" class="tab-content">
                <div class="controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="üîç Buscar..." onkeyup="searchTable()">
                    </div>
                    <button class="btn btn-secondary" onclick="exportToCSV()">üì• Exportar CSV</button>
                </div>

                <div class="table-wrapper" id="tableContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer" id="footer">
            Carregando dados...
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let charts = {};

        async function loadAllCSVs() {
            try {
                document.getElementById('footer').textContent = '‚è≥ Carregando arquivos...';

                const response = await fetch('https://api.github.com/repos/andres4victor/form_aval/contents?ref=main');
                const contents = await response.json();

                if (!Array.isArray(contents)) throw new Error('Erro ao listar arquivos');

                const csvFilesData = contents
                    .filter(item => item.type === 'file' && item.name.toLowerCase().endsWith('.csv'))
                    .map(item => ({
                        name: item.name,
                        url: item.download_url
                    }));

                let consolidatedData = [];

                for (const file of csvFilesData) {
                    const response = await fetch(file.url);
                    if (!response.ok) continue;

                    const csv = await response.text();
                    const data = parseCSV(csv);
                    consolidatedData = consolidatedData.concat(data);
                }

                allData = mergeAndDeduplicateData(consolidatedData);
                filteredData = [...allData];

                renderDashboard();
                renderTabela();
                renderRelatorio();
                generateAIAnalysis();

                document.getElementById('footer').textContent = `‚úÖ ${allData.length} registros consolidados`;

            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('footer').textContent = `‚ùå Erro: ${error.message}`;
            }
        }

        function mergeAndDeduplicateData(data) {
            const merged = {};
            data.forEach(row => {
                const keyFields = Object.keys(row)
                    .filter(k => !k.toLowerCase().includes('data') && !k.toLowerCase().includes('date'))
                    .sort();

                const key = keyFields.map(k => row[k]).join('|||');
                const dataField = Object.keys(row).find(k => k.toLowerCase().includes('data') || k.toLowerCase().includes('date'));
                const dataValue = dataField ? parseDate(row[dataField]) : new Date(0);

                if (!merged[key] || dataValue > parseDate(merged[key][dataField])) {
                    merged[key] = row;
                }
            });

            return Object.values(merged).sort((a, b) => {
                const dateFieldA = Object.keys(a).find(k => k.toLowerCase().includes('data'));
                const dateFieldB = Object.keys(b).find(k => k.toLowerCase().includes('data'));
                
                if (dateFieldA && dateFieldB) {
                    return parseDate(b[dateFieldB]) - parseDate(a[dateFieldA]);
                }
                return 0;
            });
        }

        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            const formats = [
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/,
                /(\d{4})-(\d{1,2})-(\d{1,2})/
            ];

            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    if (match[3].length === 4) {
                        const [, day, month, year] = match;
                        return new Date(year, month - 1, day);
                    } else {
                        const [, year, month, day] = match;
                        return new Date(year, month - 1, day);
                    }
                }
            }
            return new Date(dateStr);
        }

        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                const values = parseCSVLine(lines[i]);
                const obj = {};

                headers.forEach((header, index) => {
                    obj[header.trim()] = (values[index] || '').trim();
                });

                data.push(obj);
            }

            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let insideQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current);
            return result.map(v => v.replace(/^"|"$/g, ''));
        }

        function formatValue(header, value) {
            if (!value) return '---';
            const headerLower = header.toLowerCase();

            if (headerLower.includes('taxa')) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    return (num / 100).toFixed(2) + '%';
                }
            }

            return value;
        }

        function updateDashboard() {
            const period = document.getElementById('periodSelect').value;
            const now = new Date();
            let filterDate = null;

            if (period === 'last30') {
                filterDate = new Date();
                filterDate.setDate(filterDate.getDate() - 30);
            }
            if (period === 'last60') {
                filterDate = new Date();
                filterDate.setDate(filterDate.getDate() - 60);
            }
            if (period === 'last90') {
                filterDate = new Date();
                filterDate.setDate(filterDate.getDate() - 90);
            }

            const dataField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('data'));
            let filteredByPeriod = allData;

            if (filterDate && dataField) {
                filteredByPeriod = allData.filter(row => parseDate(row[dataField]) >= filterDate);
            }

            renderDashboardMetrics(filteredByPeriod);
            renderCharts(filteredByPeriod);
        }

        function renderDashboard() {
            if (allData.length === 0) return;
            renderDashboardMetrics(allData);
            renderCharts(allData);
        }

        function renderDashboardMetrics(data) {
            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            const openRateCol = headers.find(h => h.toLowerCase().includes('abertura') || h.toLowerCase().includes('open'));
            const deliveryRateCol = headers.find(h => h.toLowerCase().includes('entrega'));
            const ctrCol = headers.find(h => h.toLowerCase().includes('ctr'));
            const unsubscribeCol = headers.find(h => h.toLowerCase().includes('cancelamento'));
            const dataField = headers.find(h => h.toLowerCase().includes('data'));

            const openRate = openRateCol ? (data.reduce((sum, r) => sum + parseFloat(r[openRateCol] || 0), 0) / data.length).toFixed(2) : '0.00';
            const deliveryRate = deliveryRateCol ? (data.reduce((sum, r) => sum + parseFloat(r[deliveryRateCol] || 0), 0) / data.length).toFixed(2) : '0.00';
            const ctr = ctrCol ? (data.reduce((sum, r) => sum + parseFloat(r[ctrCol] || 0), 0) / data.length).toFixed(2) : '0.00';
            const unsubscribe = unsubscribeCol ? (data.reduce((sum, r) => sum + parseFloat(r[unsubscribeCol] || 0), 0) / data.length).toFixed(2) : '0.00';

            const ppeScores = data.map(row => {
                const or = parseFloat(row[openRateCol] || 0);
                const dr = parseFloat(row[deliveryRateCol] || 0);
                const ct = parseFloat(row[ctrCol] || 0);
                const us = parseFloat(row[unsubscribeCol] || 0);
                return (or * 0.40) - (dr * 0.35) - (us * 0.15) + (ct * 0.10);
            });
            const avgScore = (ppeScores.reduce((a, b) => a + b, 0) / ppeScores.length).toFixed(2);

            document.getElementById('kpiOpenRate').textContent = parseFloat(openRate).toFixed(2) + '%';
            document.getElementById('kpiDeliveryRate').textContent = parseFloat(deliveryRate).toFixed(2) + '%';
            document.getElementById('kpiCTR').textContent = parseFloat(ctr).toFixed(2) + '%';
            document.getElementById('kpiUnsubscribe').textContent = parseFloat(unsubscribe).toFixed(2) + '%';
            document.getElementById('kpiTotal').textContent = data.length;
            document.getElementById('kpiAvgScore').textContent = avgScore;
            document.getElementById('kpiData').textContent = dataField && data.length > 0 ? data[0][dataField] : '---';
        }

        function renderCharts(data) {
            const headers = Object.keys(data[0]);
            const dataField = headers.find(h => h.toLowerCase().includes('data'));
            const deliveryCol = headers.find(h => h.toLowerCase().includes('entrega'));
            const openCol = headers.find(h => h.toLowerCase().includes('abertura'));
            const ctrCol = headers.find(h => h.toLowerCase().includes('ctr'));
            const unsubCol = headers.find(h => h.toLowerCase().includes('cancelamento'));
            const campaignCol = headers.find(h => h.toLowerCase().includes('campanha'));

            if (dataField && deliveryCol) {
                const monthlyDelivery = {};
                data.forEach(row => {
                    const date = new Date(parseDate(row[dataField]));
                    const monthKey = date.toLocaleDateString('pt-BR', { month: 'short', year: '2-digit' });
                    
                    if (!monthlyDelivery[monthKey]) {
                        monthlyDelivery[monthKey] = [];
                    }
                    monthlyDelivery[monthKey].push(parseFloat(row[deliveryCol] || 0) / 100);
                });

                const labels = Object.keys(monthlyDelivery).sort();
                const values = labels.map(l => (monthlyDelivery[l].reduce((a, b) => a + b, 0) / monthlyDelivery[l].length * 100).toFixed(2));

                const ctx = document.getElementById('chartDeliveryTrend').getContext('2d');
                if (charts.delivery) charts.delivery.destroy();
                charts.delivery = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Taxa de Entrega Mensal (%)',
                            data: values,
                            borderColor: '#c41e3a',
                            backgroundColor: 'rgba(196, 30, 58, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 6,
                            pointBackgroundColor: '#c41e3a',
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: 'üìä Taxa de Entrega Mensal' }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }

            if (openCol && deliveryCol && ctrCol) {            const avgOpen = (data.reduce((sum, r) => sum + parseFloat(r[openCol] || 0), 0) / data.length).toFixed(2);
            const avgDelivery = (data.reduce((sum, r) => sum + parseFloat(r[deliveryCol] || 0), 0) / data.length).toFixed(2);
            const avgCtr = (data.reduce((sum, r) => sum + parseFloat(r[ctrCol] || 0), 0) / data.length).toFixed(2);
            const avgUnsub = unsubCol ? (data.reduce((sum, r) => sum + parseFloat(r[unsubCol] || 0), 0) / data.length).toFixed(2) : 0;

                const ctx = document.getElementById('chartMetricasComparacao').getContext('2d');
                if (charts.metrics) charts.metrics.destroy();
                charts.metrics = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Abertura', 'Entrega', 'Clique', 'Cancelamento'],
                        datasets: [{
                            label: 'Taxa M√©dia (%)',
                            data: [avgOpen * 100, avgDelivery * 100, avgCtr * 100, avgUnsub * 100],
                            backgroundColor: ['#c41e3a', '#27ae60', '#3498db', '#e74c3c'],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'üìà Compara√ß√£o de M√©tricas' }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }

            if (deliveryCol) {
                const sorted = [...data].sort((a, b) => parseFloat(b[deliveryCol] || 0) - parseFloat(a[deliveryCol] || 0));
                const top5 = sorted.slice(0, 5);

                const labels = top5.map((r, i) => {
                    const camp = campaignCol ? r[campaignCol].substring(0, 12) : `Camp. ${i + 1}`;
                    return camp.length > 12 ? camp.substring(0, 9) + '...' : camp;
                });
                const values = top5.map(r => (parseFloat(r[deliveryCol] || 0) / 100).toFixed(2));

                const ctx = document.getElementById('chartTopCampaigns').getContext('2d');
                if (charts.topCampaigns) charts.topCampaigns.destroy();
                charts.topCampaigns = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Taxa (%)',
                            data: values,
                            backgroundColor: '#27ae60',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: 'üèÜ Top 5' }
                        },
                        scales: {
                            x: { beginAtZero: true, max: 100 }
                        }
                    }
                });

                const bottom5 = sorted.slice(-5).reverse();
                const labelsBad = bottom5.map((r, i) => {
                    const camp = campaignCol ? r[campaignCol].substring(0, 12) : `Camp. ${i + 1}`;
                    return camp.length > 12 ? camp.substring(0, 9) + '...' : camp;
                });
                const valuesBad = bottom5.map(r => (parseFloat(r[deliveryCol] || 0) / 100).toFixed(2));

                const ctx2 = document.getElementById('chartWorstCampaigns').getContext('2d');
                if (charts.worstCampaigns) charts.worstCampaigns.destroy();
                charts.worstCampaigns = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: labelsBad,
                        datasets: [{
                            label: 'Taxa (%)',
                            data: valuesBad,
                            backgroundColor: '#e74c3c',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            title: { display: true, text: '‚ö†Ô∏è Bottom 5' }
                        },
                        scales: {
                            x: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }
        }

        function renderTabela() {
            if (allData.length === 0) return;
            filteredData = [...allData];
            displayTable();
        }

        function displayTable() {
            if (filteredData.length === 0) {
                document.getElementById('tableContainer').innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Nenhum resultado</div>';
                return;
            }

            let html = '<table><thead><tr>';
            const headers = Object.keys(filteredData[0]);
            headers.forEach(header => {
                html += `<th onclick="sortTable('${header}')">${header}</th>`;
            });

            html += '</tr></thead><tbody>';

            const displayLimit = Math.min(filteredData.length, 100);
            for (let i = 0; i < displayLimit; i++) {
                html += '<tr>';
                headers.forEach(header => {
                    const value = filteredData[i][header] || '';
                    const formatted = formatValue(header, value);
                    html += `<td>${formatted}</td>`;
                });
                html += '</tr>';
            }

            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        function searchTable() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            
            if (!query) {
                filteredData = [...allData];
            } else {
                filteredData = allData.filter(row => {
                    return Object.values(row).some(val =>
                        String(val).toLowerCase().includes(query)
                    );
                });
            }

            displayTable();
        }

        function sortTable(column) {
            filteredData.sort((a, b) => {
                const valA = a[column] || '';
                const valB = b[column] || '';

                if (column.toLowerCase().includes('data')) {
                    return parseDate(valB) - parseDate(valA);
                }

                const numA = parseFloat(valA);
                const numB = parseFloat(valB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    return numB - numA;
                }

                return String(valB).localeCompare(String(valA), 'pt-BR');
            });

            displayTable();
        }

        function renderRelatorio() {
            const headers = Object.keys(allData[0]);
            const openCol = headers.find(h => h.toLowerCase().includes('abertura'));
            const deliveryCol = headers.find(h => h.toLowerCase().includes('entrega'));
            const ctrCol = headers.find(h => h.toLowerCase().includes('ctr'));
            const unsubCol = headers.find(h => h.toLowerCase().includes('cancelamento'));
            const dataField = headers.find(h => h.toLowerCase().includes('data'));

            const avgOpen = openCol ? (allData.reduce((sum, r) => sum + parseFloat(r[openCol] || 0), 0) / allData.length).toFixed(2) : 0;
            const avgDelivery = deliveryCol ? (allData.reduce((sum, r) => sum + parseFloat(r[deliveryCol] || 0), 0) / allData.length).toFixed(2) : 0;
            const avgCtr = ctrCol ? (allData.reduce((sum, r) => sum + parseFloat(r[ctrCol] || 0), 0) / allData.length).toFixed(2) : 0;
            const avgUnsub = unsubCol ? (allData.reduce((sum, r) => sum + parseFloat(r[unsubCol] || 0), 0) / allData.length).toFixed(2) : 0;

            const resumo = `
                <p>An√°lise consolidada de <strong>${allData.length} campanhas de email</strong> da Uniasselvi.</p>
                <p>Per√≠odo at√©: <strong>${allData[0][dataField]}</strong></p>
            `;

            const kpis = `
                <li>üì® Taxa de Abertura M√©dia: <strong>${avgOpen}%</strong></li>
                <li>üì§ Taxa de Entrega M√©dia: <strong>${avgDelivery}%</strong></li>
                <li>üñ±Ô∏è Taxa de Clique (CTR) M√©dia: <strong>${avgCtr}%</strong></li>
                <li>üö´ Taxa de Cancelamento M√©dia: <strong>${avgUnsub}%</strong></li>
            `;

            const alertas = `
                <li>‚úÖ Dados consolidados e deduplicados com sucesso</li>
                <li>üìÖ √öltima atualiza√ß√£o: ${allData[0][dataField]}</li>
                <li>‚öôÔ∏è Acompanhar campanhas com taxa de entrega abaixo de 80%</li>
            `;

            document.getElementById('resumoExecutivo').innerHTML = resumo;
            document.getElementById('kpisRelatorio').innerHTML = kpis;
            document.getElementById('alertas').innerHTML = alertas;
        }

        async function generateAIAnalysis() {
            const headers = Object.keys(allData[0]);
            const openCol = headers.find(h => h.toLowerCase().includes('abertura'));
            const deliveryCol = headers.find(h => h.toLowerCase().includes('entrega'));
            const ctrCol = headers.find(h => h.toLowerCase().includes('ctr'));

            const avgOpen = openCol ? (allData.reduce((sum, r) => sum + parseFloat(r[openCol] || 0), 0) / allData.length / 100).toFixed(2) : 0;
            const avgDelivery = deliveryCol ? (allData.reduce((sum, r) => sum + parseFloat(r[deliveryCol] || 0), 0) / allData.length / 100).toFixed(2) : 0;
            const avgCtr = ctrCol ? (allData.reduce((sum, r) => sum + parseFloat(r[ctrCol] || 0), 0) / allData.length / 100).toFixed(2) : 0;

            const prompt = `An√°lise de campanhas de email Uniasselvi. Taxa abertura: ${avgOpen}%, Taxa entrega: ${avgDelivery}%, CTR: ${avgCtr}%. Forne√ßa resumo executivo em 3-4 linhas em portugu√™s com principais achados e recomenda√ß√µes.`;

            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'mixtral-8x7b-32768',
                        messages: [{role: 'user', content: prompt}],
                        max_tokens: 300
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('analiseTendencias').innerHTML = `<strong>üìä An√°lise IA:</strong><br>${data.choices[0].message.content}`;
                } else {
                    document.getElementById('analiseTendencias').innerHTML = `<strong>üìä Resumo:</strong><br>Taxa de abertura <strong>${(avgOpen * 100).toFixed(2)}%</strong>, entrega <strong>${(avgDelivery * 100).toFixed(2)}%</strong> e clique <strong>${(avgCtr * 100).toFixed(2)}%</strong>. Otimize linhas de assunto e segmenta√ß√£o.`;
                }
            } catch (error) {
                document.getElementById('analiseTendencias').innerHTML = `<strong>üìä Resumo:</strong><br>Taxa de abertura <strong>${(avgOpen * 100).toFixed(2)}%</strong>, entrega <strong>${(avgDelivery * 100).toFixed(2)}%</strong> e clique <strong>${(avgCtr * 100).toFixed(2)}%</strong>.`;
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');

            if (tab === 'mensais' && !document.getElementById('monthlyContainer').querySelector('.monthly-card')) {
                renderMonthlyAnalysis();
            }
            if (tab === 'faq' && !document.getElementById('faqContainer').querySelector('.faq-card')) {
                renderFAQ();
            }
        }

        function renderFAQ() {
            const faqData = [
                { title: 'Taxa de Abertura', badge: '+40%', description: 'Mede interesse no email', formula: '(Aberturas / Entregas) √ó 100', benchmark: '> 25% = Excelente' },
                { title: 'Taxa de Entrega', badge: 'Core', description: 'Emails entregues com sucesso', formula: '(Entregues / Enviados) √ó 100', benchmark: '> 95% = Excelente' },
                { title: 'Taxa de Clique (CTR)', badge: '+10%', description: 'Cliques em links', formula: '(Cliques / Entregas) √ó 100', benchmark: '> 3% = Excelente' },
                { title: 'Taxa de Cancelamento', badge: '-15%', description: 'Usu√°rios desinscritos', formula: '(Cancelamentos / Entregas) √ó 100', benchmark: '< 0.5% = Excelente' }
            ];

            const container = document.getElementById('faqContainer');
            container.innerHTML = '';

            faqData.forEach(item => {
                const card = document.createElement('div');
                card.className = 'faq-card';
                card.innerHTML = `
                    <h4 onclick="this.parentElement.classList.toggle('open');">
                        ${item.title}
                        <span class="metric-badge">${item.badge}</span>
                    </h4>
                    <div class="faq-answer">
                        <p><strong>O que mede:</strong> ${item.description}</p>
                        <div class="metric-detail"><strong>F√≥rmula:</strong><br>${item.formula}</div>
                        <div class="metric-detail"><strong>Benchmark:</strong><br>${item.benchmark}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function renderMonthlyAnalysis() {
            const headers = Object.keys(allData[0]);
            const dataField = headers.find(k => k.toLowerCase().includes('data'));
            const openCol = headers.find(h => h.toLowerCase().includes('abertura'));
            const deliveryCol = headers.find(h => h.toLowerCase().includes('entrega'));
            const ctrCol = headers.find(h => h.toLowerCase().includes('ctr'));

            if (!dataField) return;

            const monthlyData = {};
            allData.forEach(row => {
                const date = new Date(parseDate(row[dataField]));
                const monthKey = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = [];
                }
                monthlyData[monthKey].push(row);
            });

            const container = document.getElementById('monthlyContainer');
            container.innerHTML = '';

            Object.entries(monthlyData).forEach(([month, records]) => {            const avgOpen = openCol ? (records.reduce((sum, r) => sum + parseFloat(r[openCol] || 0), 0) / records.length).toFixed(2) : '0.00';
            const avgDelivery = deliveryCol ? (records.reduce((sum, r) => sum + parseFloat(r[deliveryCol] || 0), 0) / records.length).toFixed(2) : '0.00';
            const avgCtr = ctrCol ? (records.reduce((sum, r) => sum + parseFloat(r[ctrCol] || 0), 0) / records.length).toFixed(2) : '0.00';

                const card = document.createElement('div');
                card.className = 'monthly-card';
                card.innerHTML = `
                    <h4>üìÖ ${month}</h4>
                    <div class="metric-row">
                        <span class="metric-label">Taxa Abertura M√©dia:</span>
                        <span class="metric-value">${avgOpen}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Taxa Entrega M√©dia:</span>
                        <span class="metric-value">${avgDelivery}%</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-label">Taxa Clique M√©dia:</span>
                        <span class="metric-value">${avgCtr}%</span>
                    </div>
                    <div class="metric-row" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #c41e3a;">
                        <span class="metric-label">Campanhas:</span>
                        <span class="metric-value">${records.length}</span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function exportToCSV() {
            const headers = Object.keys(allData[0]);
            let csv = headers.join(',') + '\n';

            allData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `PPE_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        window.addEventListener('load', () => {
            loadAllCSVs();
        });
    </script>
</body>
</html>
