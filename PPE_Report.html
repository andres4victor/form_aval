<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPE Report Dashboard - Enterprise</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-bottom: 5px solid rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: clamp(1.5em, 5vw, 2.5em);
            margin-bottom: 5px;
            font-weight: 700;
        }

        .header p {
            font-size: clamp(0.9em, 3vw, 1.1em);
            opacity: 0.95;
        }

        .content {
            padding: clamp(15px, 5vw, 30px);
            flex: 1;
            overflow-y: auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
            flex-wrap: wrap;
        }

        .tab-btn {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            font-size: 0.95em;
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-btn:hover {
            color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 5px solid #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .kpi-label {
            font-size: 0.8em;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 2em;
            color: #667eea;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .kpi-change {
            font-size: 0.85em;
            margin-top: 5px;
            color: #666;
        }

        .kpi-change.up {
            color: #27ae60;
        }

        .kpi-change.down {
            color: #e74c3c;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            height: 400px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.2);
        }

        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #ecf0f1;
            color: #333;
        }

        .btn-secondary:hover {
            background: #bdc3c7;
        }

        .table-wrapper {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 20px;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 600px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85em;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
            border: 1px solid rgba(0,0,0,0.1);
        }

        th:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
            font-size: 0.9em;
            word-wrap: break-word;
            word-break: break-word;
        }

        tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        tbody tr:hover {
            background: #f0f4ff;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #7f8c8d;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #ecf0f1;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .footer {
            background: #f9fafb;
            border-top: 1px solid #ecf0f1;
            padding: 15px 20px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.85em;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .status-good {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .report-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .report-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .report-list li {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                text-align: left;
            }

            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä PPE Report Dashboard Enterprise</h1>
            <p>An√°lise Consolidada e Relat√≥rio Gerencial - v5.0</p>
        </div>

        <div class="content">
            <!-- TABS -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('dashboard')">üìà Dashboard</button>
                <button class="tab-btn" onclick="switchTab('relatorio')">üìã Relat√≥rio Gerencial</button>
                <button class="tab-btn" onclick="switchTab('dados')">üìä Dados Detalhados</button>
            </div>

            <!-- TAB: DASHBOARD -->
            <div id="dashboard" class="tab-content active">
                <!-- STATUS -->
                <div class="kpi-grid" id="kpiContainer">
                    <div class="kpi-card">
                        <div class="kpi-label">Total de Registros</div>
                        <div class="kpi-value" id="kpiTotal">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Taxa M√©dia (%)</div>
                        <div class="kpi-value" id="kpiMedia">0%</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Registros Ativos</div>
                        <div class="kpi-value" id="kpiAtivos">0</div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-label">Data √öltima Atualiza√ß√£o</div>
                        <div class="kpi-value" id="kpiData" style="font-size: 1.2em;">--</div>
                    </div>
                </div>

                <!-- GR√ÅFICOS -->
                <div class="chart-container">
                    <canvas id="chartTendencia"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="chartDistribuicao"></canvas>
                </div>

                <div class="chart-container">
                    <canvas id="chartComparativo"></canvas>
                </div>
            </div>

            <!-- TAB: RELAT√ìRIO GERENCIAL -->
            <div id="relatorio" class="tab-content">
                <div class="report-section">
                    <h3>üìå Resumo Executivo</h3>
                    <div id="resumoExecutivo"></div>
                </div>

                <div class="report-section">
                    <h3>üéØ KPIs e M√©tricas Principais</h3>
                    <ul class="report-list" id="kpisRelatorio"></ul>
                </div>

                <div class="report-section">
                    <h3>üìä An√°lise de Tend√™ncias</h3>
                    <div id="analiseTendencias"></div>
                </div>

                <div class="report-section">
                    <h3>‚ö†Ô∏è Alertas e Recomenda√ß√µes</h3>
                    <ul class="report-list" id="alertas"></ul>
                </div>

                <button class="btn" onclick="exportarRelatorio()" style="width: 100%; margin-top: 20px;">üìÑ Exportar Relat√≥rio (PDF)</button>
            </div>

            <!-- TAB: DADOS DETALHADOS -->
            <div id="dados" class="tab-content">
                <div class="controls">
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="üîç Buscar em todas as colunas...">
                    </div>
                    <button class="btn btn-secondary" onclick="exportToCSV()">üì• Exportar CSV</button>
                </div>

                <div class="table-wrapper" id="tableContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Carregando dados...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer" id="footer">
            Carregando dados...
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let csvFiles = [];
        let charts = {};

        // ===== CARREGAR TODOS OS CSVS AUTOMATICAMENTE =====
        async function loadAllCSVs() {
            try {
                document.getElementById('footer').textContent = '‚è≥ Carregando arquivos...';

                const response = await fetch('https://api.github.com/repos/andres4victor/form_aval/contents?ref=main');
                const contents = await response.json();

                if (!Array.isArray(contents)) throw new Error('Erro ao listar arquivos');

                const csvFilesData = contents
                    .filter(item => item.type === 'file' && item.name.toLowerCase().endsWith('.csv'))
                    .map(item => ({
                        name: item.name,
                        url: item.download_url,
                        size: item.size
                    }));

                if (csvFilesData.length === 0) {
                    throw new Error('Nenhum arquivo CSV encontrado');
                }

                let consolidatedData = [];

                for (const file of csvFilesData) {
                    const response = await fetch(file.url);
                    if (!response.ok) continue;

                    const csv = await response.text();
                    const data = parseCSV(csv);
                    consolidatedData = consolidatedData.concat(data);
                }

                allData = mergeAndDeduplicateData(consolidatedData);
                filteredData = [...allData];

                renderDashboard();
                renderTabela();
                renderRelatorio();

                document.getElementById('footer').textContent = `‚úÖ ${allData.length} registros consolidados de ${csvFilesData.length} arquivo(s)`;

            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('footer').textContent = `‚ùå Erro: ${error.message}`;
            }
        }

        // ===== MERGE E DEDUPLICA√á√ÉO DE DADOS =====
        function mergeAndDeduplicateData(data) {
            const merged = {};

            data.forEach(row => {
                // Criar chave baseada em todas as colunas exceto data
                const keyFields = Object.keys(row)
                    .filter(k => !k.toLowerCase().includes('data') && !k.toLowerCase().includes('date') && !k.toLowerCase().includes('hora') && !k.toLowerCase().includes('time'))
                    .sort();

                const key = keyFields.map(k => row[k]).join('|||');
                const dataField = Object.keys(row).find(k => k.toLowerCase().includes('data') || k.toLowerCase().includes('date'));
                const dataValue = dataField ? parseDate(row[dataField]) : new Date(0);

                if (!merged[key] || dataValue > parseDate(merged[key][dataField])) {
                    merged[key] = row;
                }
            });

            return Object.values(merged).sort((a, b) => {
                const dateFieldA = Object.keys(a).find(k => k.toLowerCase().includes('data') || k.toLowerCase().includes('date'));
                const dateFieldB = Object.keys(b).find(k => k.toLowerCase().includes('data') || k.toLowerCase().includes('date'));
                
                if (dateFieldA && dateFieldB) {
                    return parseDate(b[dateFieldB]) - parseDate(a[dateFieldA]);
                }
                return 0;
            });
        }

        // ===== PARSER DE DATA =====
        function parseDate(dateStr) {
            if (!dateStr) return new Date(0);
            
            const formats = [
                /(\d{1,2})\/(\d{1,2})\/(\d{4})/,  // DD/MM/YYYY
                /(\d{4})-(\d{1,2})-(\d{1,2})/      // YYYY-MM-DD
            ];

            for (const format of formats) {
                const match = dateStr.match(format);
                if (match) {
                    if (match[3].length === 4) {
                        const [, day, month, year] = match;
                        return new Date(year, month - 1, day);
                    } else {
                        const [, year, month, day] = match;
                        return new Date(year, month - 1, day);
                    }
                }
            }

            return new Date(dateStr);
        }

        // ===== PARSER CSV =====
        function parseCSV(csv) {
            const lines = csv.trim().split('\n');
            if (lines.length < 2) return [];

            const headers = parseCSVLine(lines[0]);
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;

                const values = parseCSVLine(lines[i]);
                const obj = {};

                headers.forEach((header, index) => {
                    obj[header.trim()] = (values[index] || '').trim();
                });

                data.push(obj);
            }

            return data;
        }

        // ===== PARSER DE LINHA CSV =====
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let insideQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];

                if (char === '"') {
                    insideQuotes = !insideQuotes;
                } else if (char === ',' && !insideQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }

            result.push(current);
            return result.map(v => v.replace(/^"|"$/g, ''));
        }

        // ===== FORMATAR VALORES =====
        function formatValue(header, value) {
            if (!value) return '---';

            const headerLower = header.toLowerCase();

            // Taxa em porcentagem
            if (headerLower.includes('taxa') || headerLower.includes('percentage')) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                    return (num / 100).toFixed(2) + '%';
                }
            }

            // Data
            if (headerLower.includes('data') || headerLower.includes('date')) {
                return value;
            }

            return value;
        }

        // ===== RENDERIZAR DASHBOARD =====
        function renderDashboard() {
            if (allData.length === 0) return;

            // KPIs
            const totalRecords = allData.length;
            const taxaField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('taxa'));
            const taxaMedia = taxaField ? (allData.reduce((sum, r) => sum + parseFloat(r[taxaField] || 0), 0) / allData.length / 100).toFixed(2) : 0;
            const dataField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('data'));
            const dataUltima = dataField ? allData[0][dataField] : '---';

            document.getElementById('kpiTotal').textContent = totalRecords;
            document.getElementById('kpiMedia').textContent = taxaMedia + '%';
            document.getElementById('kpiAtivos').textContent = allData.filter(r => r.Status === 'Ativo' || r.status === 'Ativo').length;
            document.getElementById('kpiData').textContent = dataUltima;

            // Gr√°ficos
            renderCharts();
        }

        // ===== RENDERIZAR GR√ÅFICOS =====
        function renderCharts() {
            const taxaField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('taxa'));
            const dataField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('data'));
            const classificacaoField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('classificacao'));

            if (!taxaField) return;

            // Gr√°fico 1: Tend√™ncia Temporal
            if (dataField) {
                const dataTaxaMap = {};
                allData.forEach(row => {
                    const data = row[dataField].split(' ')[0];
                    if (!dataTaxaMap[data]) dataTaxaMap[data] = [];
                    dataTaxaMap[data].push(parseFloat(row[taxaField] || 0) / 100);
                });

                const labels = Object.keys(dataTaxaMap).sort((a, b) => parseDate(a) - parseDate(b));
                const values = labels.map(l => (dataTaxaMap[l].reduce((a, b) => a + b, 0) / dataTaxaMap[l].length).toFixed(2));

                const ctx = document.getElementById('chartTendencia').getContext('2d');
                if (charts.tendencia) charts.tendencia.destroy();
                charts.tendencia = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Taxa M√©dia (%)',
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 5,
                            pointBackgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: 'üìà Tend√™ncia de Taxa ao Longo do Tempo' }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }

            // Gr√°fico 2: Distribui√ß√£o
            if (classificacaoField) {
                const classTaxaMap = {};
                allData.forEach(row => {
                    const classe = row[classificacaoField] || 'Sem Classifica√ß√£o';
                    if (!classTaxaMap[classe]) classTaxaMap[classe] = [];
                    classTaxaMap[classe].push(parseFloat(row[taxaField] || 0) / 100);
                });

                const labels = Object.keys(classTaxaMap);
                const values = labels.map(l => (classTaxaMap[l].reduce((a, b) => a + b, 0) / classTaxaMap[l].length * 100).toFixed(2));
                const colors = ['#667eea', '#764ba2', '#27ae60', '#e74c3c', '#f39c12', '#3498db'];

                const ctx = document.getElementById('chartDistribuicao').getContext('2d');
                if (charts.distribuicao) charts.distribuicao.destroy();
                charts.distribuicao = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Taxa M√©dia por Classifica√ß√£o (%)',
                            data: values,
                            backgroundColor: colors.slice(0, labels.length),
                            borderColor: colors.slice(0, labels.length),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: 'üìä Taxa M√©dia por Classifica√ß√£o' }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });
            }

            // Gr√°fico 3: Comparativo
            const top5 = allData.slice(0, 5);
            const ctx = document.getElementById('chartComparativo').getContext('2d');
            if (charts.comparativo) charts.comparativo.destroy();
            charts.comparativo = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: top5.map((_, i) => `Registro ${i + 1}`),
                    datasets: [{
                        label: 'Taxa (%)',
                        data: top5.map(r => (parseFloat(r[taxaField] || 0) / 100).toFixed(2)),
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        pointBackgroundColor: '#667eea',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        title: { display: true, text: 'üéØ Comparativo dos Top 5 Registros' }
                    },
                    scales: {
                        r: { beginAtZero: true, max: 100 }
                    }
                }
            });
        }

        // ===== RENDERIZAR TABELA =====
        function renderTabela() {
            if (allData.length === 0) return;

            let html = '<table><thead><tr>';
            const headers = Object.keys(allData[0]);
            headers.forEach(header => {
                html += `<th onclick="sortTable('${header}')">${header}</th>`;
            });

            html += '</tr></thead><tbody>';

            const displayLimit = Math.min(allData.length, 100);
            for (let i = 0; i < displayLimit; i++) {
                html += '<tr>';
                headers.forEach(header => {
                    const value = allData[i][header] || '';
                    const formatted = formatValue(header, value);
                    html += `<td>${formatted}</td>`;
                });
                html += '</tr>';
            }

            html += '</tbody></table>';
            document.getElementById('tableContainer').innerHTML = html;
        }

        // ===== ORDENAR TABELA =====
        function sortTable(column) {
            allData.sort((a, b) => {
                const valA = a[column] || '';
                const valB = b[column] || '';

                // Se √© data
                if (column.toLowerCase().includes('data') || column.toLowerCase().includes('date')) {
                    return parseDate(b) - parseDate(a);
                }

                // Se √© n√∫mero
                const numA = parseFloat(valA);
                const numB = parseFloat(valB);

                if (!isNaN(numA) && !isNaN(numB)) {
                    return numB - numA;
                }

                return String(valB).localeCompare(String(valA), 'pt-BR');
            });

            renderTabela();
        }

        // ===== RENDERIZAR RELAT√ìRIO =====
        function renderRelatorio() {
            const taxaField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('taxa'));
            const dataField = Object.keys(allData[0]).find(k => k.toLowerCase().includes('data'));

            const resumo = `
                <p>
                    Este relat√≥rio consolida dados de <strong>${allData.length} registros</strong> de m√∫ltiplas fontes.
                    A an√°lise apresenta a taxa m√©dia de <strong>${((allData.reduce((sum, r) => sum + parseFloat(r[taxaField] || 0), 0) / allData.length / 100).toFixed(2))}%</strong>.
                    O per√≠odo de an√°lise vai at√© <strong>${allData[0][dataField]}</strong>.
                </p>
            `;

            const kpis = `
                <li>üìä <strong>Taxa M√©dia:</strong> ${((allData.reduce((sum, r) => sum + parseFloat(r[taxaField] || 0), 0) / allData.length / 100).toFixed(2))}%</li>
                <li>üìà <strong>Taxa M√°xima:</strong> ${((Math.max(...allData.map(r => parseFloat(r[taxaField] || 0))) / 100).toFixed(2))}%</li>
                <li>üìâ <strong>Taxa M√≠nima:</strong> ${((Math.min(...allData.map(r => parseFloat(r[taxaField] || 0))) / 100).toFixed(2))}%</li>
                <li>üéØ <strong>Registros √önicos:</strong> ${allData.length}</li>
            `;

            const alertas = `
                <li>‚úÖ <span class="status-badge status-good">Dados Consolidados</span> Todos os arquivos foram carregados e deduplicados com sucesso</li>
                <li>üìÖ <span class="status-badge status-good">Atualizado</span> √öltima atualiza√ß√£o: ${allData[0][dataField]}</li>
                <li>‚öôÔ∏è Recomenda√ß√£o: Acompanhar tend√™ncias de taxa ao longo do tempo</li>
            `;

            document.getElementById('resumoExecutivo').innerHTML = resumo;
            document.getElementById('kpisRelatorio').innerHTML = kpis;
            document.getElementById('alertas').innerHTML = alertas;
        }

        // ===== SWITCH TAB =====
        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            event.target.classList.add('active');
        }

        // ===== EXPORTAR CSV =====
        function exportToCSV() {
            const headers = Object.keys(allData[0]);
            let csv = headers.join(',') + '\n';

            allData.forEach(row => {
                const values = headers.map(header => {
                    const value = row[header] || '';
                    return `"${String(value).replace(/"/g, '""')}"`;
                });
                csv += values.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `PPE_Consolidado_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        // ===== EXPORTAR RELAT√ìRIO =====
        function exportarRelatorio() {
            alert('Exporta√ß√£o de PDF ser√° implementada em breve!');
        }

        // ===== INICIALIZAR =====
        window.addEventListener('load', () => {
            loadAllCSVs();
        });
    </script>
</body>
</html>
